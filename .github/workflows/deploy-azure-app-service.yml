name: Deploy to Azure App Service

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AZURE_WEBAPP_NAME: credo-app
  CONTAINER_REGISTRY: credoregistry.azurecr.io
  CONTAINER_NAME: credo-app

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          DIRECT_URL: postgresql://dummy:dummy@localhost:5432/dummy

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.CONTAINER_REGISTRY }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build Docker image
          docker build -t ${{ env.CONTAINER_REGISTRY }}/${{ env.CONTAINER_NAME }}:$IMAGE_TAG .
          docker build -t ${{ env.CONTAINER_REGISTRY }}/${{ env.CONTAINER_NAME }}:latest .
          
          # Push images
          docker push ${{ env.CONTAINER_REGISTRY }}/${{ env.CONTAINER_NAME }}:$IMAGE_TAG
          docker push ${{ env.CONTAINER_REGISTRY }}/${{ env.CONTAINER_NAME }}:latest

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ env.CONTAINER_REGISTRY }}/${{ env.CONTAINER_NAME }}:${{ github.sha }}
          container-command: 'npm start'

      - name: Update App Service settings
        uses: Azure/cli@v1
        with:
          inlineScript: |
            az webapp config appsettings set \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --settings \
              WEBSITES_PORT=3000 \
              NODE_ENV=production \
              DOCKER_CUSTOM_IMAGE_NAME=${{ env.CONTAINER_REGISTRY }}/${{ env.CONTAINER_NAME }}:${{ github.sha }}

      - name: Get App Service URL
        id: app-url
        run: |
          APP_URL=$(az webapp show \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --query defaultHostName \
            --output tsv)
          echo "url=https://$APP_URL" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: sleep 60

      - name: Health check
        run: |
          curl -f ${{ steps.app-url.outputs.url }}/api/health || exit 1

      - name: Configure auto-scaling
        uses: Azure/cli@v1
        with:
          inlineScript: |
            az monitor autoscale create \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --resource ${{ env.AZURE_WEBAPP_NAME }}/providers/Microsoft.Web/sites \
              --resource-type Microsoft.Web/sites \
              --min-count 1 \
              --max-count 3 \
              --count 1 \
              --name credo-app-autoscale

            az monitor autoscale rule create \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --autoscale-name credo-app-autoscale \
              --condition "Percentage CPU > 70" \
              --scale out 1

            az monitor autoscale rule create \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --autoscale-name credo-app-autoscale \
              --condition "Percentage CPU < 30" \
              --scale in 1 \
              --cooldown 5

      - name: Notify deployment success
        run: |
          echo "ðŸš€ Deployment to Azure successful!"
          echo "ðŸ“Š App URL: ${{ steps.app-url.outputs.url }}"
          echo "ðŸ¥ Health check: ${{ steps.app-url.outputs.url }}/api/health"

  rollback:
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Rollback deployment
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ env.CONTAINER_REGISTRY }}/${{ env.CONTAINER_NAME }}:latest
          container-command: 'npm start'
      
      - name: Notify rollback
        run: echo "ðŸ”„ Deployment failed. Rolled back to previous version."
